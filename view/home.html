<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8' />
    <title>Title</title>

    <link
        crossorigin='anonymous'
        href='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css'
        integrity='sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm'
        rel='stylesheet'
    />
    <link
        href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css'
        rel='stylesheet'
    />

    <style>
        html,
        body {
            height: 100%;
        }

        .chart_container {
            width: 100%;
            height: 400px;
        }

        .chart-canvas-container {
            display: inline-block;
            width: 80%;
            height: 100%;
            float: left;
        }

        .chart-statistics-container {
            display: inline-block;
            width: 20%;
            height: 100%;
            float: right;
        }
    </style>
</head>
<body>
<template id='template_input_sprint'>
    <div class='input_sprint'>
        <label for='sprint_begin'>From: </label>
        <input class='form-control' id='sprint_begin' type='date' />
        <label for='sprint_end'>to: </label>
        <input class='form-control' id='sprint_end' type='date' />
    </div>
    <br />
</template>

<nav class='navbar navbar-expand-md navbar-dark bg-dark mb-4'>
    <div class='navbar-brand'>Agile Metrics</div>
    <div class='collapse navbar-collapse'>
        <ul class='navbar-nav mr-auto'>
            <li class='nav-item active'>
                <a
                    class='nav-link'
                    href='/repositoryguide/view/home.html'
                    id='button_navigate_home'
                >
                    <i class='fa fa-home' aria-hidden='true'></i>
                    Home
                </a>
            </li>
            <li class='nav-item'>
                <a
                    class='nav-link'
                    href='/repositoryguide/view/team/overview.html'
                    id='button_navigate_teams'
                >
                    Teams
                </a>
            </li>
            <li class='nav-item'>
                <a
                    class='nav-link'
                    href='/repositoryguide/view/sprint/overview.html'
                    id='button_navigate_sprint'
                >
                    Sprints
                </a>
            </li>
            <li class='nav-item'>
                <a
                    class='nav-link'
                    href='/repositoryguide/view/settings.html'
                    id='button_navigate_settings'
                >
                    <i class='fa fa-cogs' aria-hidden='true'></i>
                    Settings
                </a>
            </li>
        </ul>
    </div>
</nav>

<div class='card container' id='settings_container'>
    <div class='card-header'>
        <h3>Home</h3>
    </div>
    <div class='form-group card-body'>
        <ul class='nav nav-tabs' id='myTab' role='tablist'>
            <li class='nav-item' role='presentation'>
                <button
                    class='nav-link active'
                    id='nav-pull-request-tab'
                    data-bs-toggle='tab'
                    data-bs-target='#pull-requests'
                    type='button'
                    role='tab'
                    aria-controls='nav-pull-requests'
                    aria-selected='true'
                >
                    Pull Requests
                </button>
            </li>
            <li class='nav-item' role='presentation'>
                <button
                    class='nav-link'
                    id='nav-commits-tab'
                    data-bs-toggle='tab'
                    data-bs-target='#commits'
                    type='button'
                    role='tab'
                    aria-controls='nav-commits'
                    aria-selected='false'
                >
                    Commits
                </button>
            </li>
            <li class='nav-item' role='presentation'>
                <button
                    class='nav-link'
                    id='nav-issues-tab'
                    data-bs-toggle='tab'
                    data-bs-target='#issues'
                    type='button'
                    role='tab'
                    aria-controls='issues'
                    aria-selected='false'
                >
                    Issues
                </button>
            </li>
        </ul>
        <div class='tab-content'>
            <div
                class='tab-pane active show'
                id='pull-requests'
                role='tabpanel'
                aria-labelledby='nav-pull-request-tab'
            >
                <div class='chart_container' id='pr_closing_times_container'>
                    <div class='chart-canvas-container'>
                        <canvas
                            class='svg-container chart-canvas'
                            data-metric='Pull request closing times'
                        ></canvas>
                    </div>
                    <div
                        class='chart-statistics-container'
                        data-metric='Pull request closing times'
                    ></div>
                </div>
                <div class='chart_container' id='pr_closing_times_in_buckets_container'>
                    <div class='chart-canvas-container'>
                        <canvas
                            class='svg-container chart-canvas'
                            data-metric='Pull request closing times in buckets overall'
                        ></canvas>
                    </div>
                    <div
                        class='chart-statistics-container'
                        data-metric='Pull request closing times in buckets overall'
                    ></div>
                </div>
                <div
                    class='chart_container'
                    id='pr_closing_times_in_buckets_sprint_segmented_container'
                >
                    <div class='chart-canvas-container'>
                        <canvas
                            class='svg-container chart-canvas'
                            data-metric='Pull request closing times in buckets per sprint'
                        ></canvas>
                    </div>
                    <div
                        class='chart-statistics-container'
                        data-metric='Pull request closing times in buckets per sprint'
                    ></div>
                </div>
            </div>
            <div
                class='tab-pane'
                id='commits'
                role='tabpanel'
                aria-labelledby='nav-commits-tab'
            >
                <div class='chart_container' id='commit_times_container'>
                    <div class='chart-canvas-container'>
                        <canvas
                            class='svg-container chart-canvas'
                            data-metric='Commit times'
                        ></canvas>
                    </div>
                    <div
                        class='chart-statistics-container'
                        data-metric='Commit times'
                    ></div>
                </div>
            </div>
            <div
                class='tab-pane'
                id='issues'
                role='tabpanel'
                aria-labelledby='nav-issues-tab'
            >
                <div class='chart_container' id='issues_sizes_container'>
                    <div class='chart-canvas-container'>
                        <canvas
                            class='svg-container chart-canvas'
                            data-metric='Issue sizes in buckets'
                        ></canvas>
                    </div>
                    <div
                        class='chart-statistics-container'
                        data-metric='Issue sizes in buckets'
                    ></div>
                </div>
                <div class='chart_container' id='issues_sizes_in_buckets_container'>
                    <div class='chart-canvas-container'>
                        <canvas
                            class='svg-container chart-canvas'
                            data-metric='Issue sizes'
                        ></canvas>
                    </div>
                    <div class='chart-statistics-container' data-metric='Issue sizes'></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type='module'>
    import Config from '../config.js'
    import { metrics } from '../metrics.js'

    let config = Config.from_session_storage()

    document
        .getElementById('button_navigate_home')
        .addEventListener('click', (event) => event.preventDefault())
    document
        .getElementById('button_navigate_teams')
        .addEventListener('click', () => config.to_session_storage())
    document
        .getElementById('button_navigate_sprint')
        .addEventListener('click', () => config.to_session_storage())
    document
        .getElementById('button_navigate_settings')
        .addEventListener('click', () => config.to_session_storage())

    async function initializeChart(
        chartClass,
        canvas,
        statistics_container,
        data_retrieval_function,
        sprint_segmented,
        title,
        data_title,
        config
    ) {
        const chart = new chartClass({
            canvas: canvas,
            statistics_container: statistics_container
        })
        chart.data = await data_retrieval_function(config, sprint_segmented)
        chart.title = title
        chart.data_title = data_title
        chart.config = config
        chart.draw()
    }

    ;(async () => {
        const canvases = [...document.getElementsByClassName('chart-canvas')]
        const statistic_containers = [
            ...document.getElementsByClassName('chart-statistics-container')
        ]
        const groups = {}

        canvases.forEach((canvas) => {
            if (!groups[canvas.dataset.metric]) {
                groups[canvas.dataset.metric] = {}
            }
            groups[canvas.dataset.metric].canvas = canvas
        })
        statistic_containers.forEach((container) => {
            if (!groups[container.dataset.metric]) {
                groups[container.dataset.metric] = {}
            }
            groups[container.dataset.metric].statistics_container = container
        })

        const promises = []
        for (const metric_name of Object.keys(groups)) {
            const metric = metrics[metric_name]
            const group = groups[metric_name]
            promises.push(
                initializeChart(
                    metric.chart_class,
                    group.canvas,
                    group.statistics_container,
                    metric.data_retrieval_function,
                    metric.sprint_segmented,
                    metric_name,
                    metric_name,
                    config
                )
            )
        }
        await Promise.all(promises)
    })()
</script>

<script src='../external/bootstrap.js'></script>
</body>
</html>
